<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Ciudadanos de 4 Patas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <link rel="stylesheet" href="style.css" >
        <style>
            body {font-family: Arial, Helvetica, sans-serif;}
            * {box-sizing: border-box;}
            /* Button used to open the chat form - fixed at the bottom of the page */
            .open-button {
                background-color: #555;
                color: white;
                padding: 16px 20px;
                border: none;
                cursor: pointer;
                opacity: 0.8;
                position: fixed;
                bottom: 23px;
                right: 28px;
                width: 280px;
            }

            /* The popup chat - hidden by default */
            .chat-popup {
                display: none;
                position: fixed;
                bottom: 0;
                right: 15px;
                border: 3px solid #f1f1f1;
                z-index: 9;
            }

            /* Add styles to the form container */
            .table-container {
                max-width: 300px;
                padding: 10px;
                background-color: white;
            }

            /* Full-width textarea */
            .table-container textarea {
                width: 100%;
                padding: 15px;
                margin: 5px 0 22px 0;
                border: none;
                background: #f1f1f1;
                resize: none;
                min-height: 200px;
            }

            /* Full-width input */
            .table-container input {
                width: 100%;
                padding: 15px;
                margin: 5px 0 22px 0;
                border: none;
                background: #f1f1f1;
                resize: none;
                min-height: 200px;
            }


            /* When the textarea gets focus, do something */
            .table-container textarea:focus {
                background-color: #ddd;
                outline: none;
            }

            /* When the input gets focus, do something */
            .table-container input:focus {
                background-color: #ddd;
                outline: none;
            }

            /* Set a style for the submit/send button */
            .table-container .btn {
                background-color: #04AA6D;
                color: white;
                padding: 16px 20px;
                border: none;
                cursor: pointer;
                width: 100%;
                margin-bottom:10px;
                opacity: 0.8;
            }

            /* Add a red background color to the cancel button */
            .table-container .cancel {
                background-color: red;
            }

            /* Add some hover effects to buttons */
            .table-container .btn:hover, .open-button:hover {
                opacity: 1;
            }
        </style>
    </head>
    <body class="Body">
        <div class="contenedor text-center jumbotron" >
                <h1>Ciudadano de 4 Patas</h1>
        </div>
        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <div class="col" style="padding-left: 100px">
                <img  src="./Img/pata.png" style="margin-left:20px" width="75" height="75">
                <a class="navbar-brand" style="margin-left:20px">Bienvenid@</a>
            </div>
            <div class="col" style="text-align: right; padding-right: 250px">
                <button class="btn btn-secondary" id="logout-button">Logout</button>
            </div>
        </nav>
        <div class="row">
            <div class=" tabla col-sm-7" style="margin-top:30px">
                <form class="needs-validation" action="vet.html"  novalidate>
                    <div class="form-group">
                        <label  class="mb-2 mr-sm-2"> Nombre de la Veterinaria:</label>
                        <input id="namevet-input" type="text" class="form-control mb-2 mr-sm-2" placeholder="Nombre" name="nameVet"required/>
                        <div class="valid-feedback">Validado.</div>
                        <div class="invalid-feedback">Por favor llene este campo.</div>
                    </div>
                    <div class="form-group">
                        <label  class="mb-2 mr-sm-2"> Numero de identificacion de la mascota:</label>
                        <input id="petId-input" type="number" min="0" max="10000000000000" class="form-control mb-2 mr-sm-2" placeholder="Id" name="petId"/>
                    </div>
                    <div class="form-group">
                        <label  class="mb-2 mr-sm-2">Tipo de visita:</label>
                        <select id="type-input"required>
                            <option></option>
                            <option>Esterilizacion</option>
                            <option>Implantacion_de_Microchip</option>
                            <option>Vacunacion</option>
                            <option>desparacitacion</option>
                            <option>Urgencia</option>
                            <option>Control</option>
                        </select>
                        <div class="valid-feedback">Validado.</div>
                        <div class="invalid-feedback">Por favor llene este campo.</div>
                    </div>
                    <div class="form-group">
                        <label  class="mb-2 mr-sm-2"> Numero de Microchip:</label>
                        <input id="microchip-input" type="number" min="0" max="10000000000000" class="form-control mb-2 mr-sm-2" placeholder="microchip" name="petId" disabled="disabled"/>
                    </div>
                    <div class="form-group">
                        <label  class="mb-2 mr-sm-2"> Descripcion:</label>
                        <input id="description-input" type="text" class="form-control mb-2 mr-sm-2" placeholder="Descripcion" name="description"required/>
                        <div class="valid-feedback">Validado.</div>
                        <div class="invalid-feedback">Por favor llene este campo.</div>
                    </div>
                    <input id="petsave-button"  type="submit"  class="btn btn-outline-success" value="Guardar"/>
                    <input id="petclean-button" type="reset" class="btn btn-outline-danger"value="Limpiar" />
                </form>
                <br/><br/><br/><br/><br/>
                <label  class="mb-2 mr-sm-2"> Nombre de la Veterinaria:</label>
                <input id="namevet2-input" type="text" class="form-control mb-2 mr-sm-2" placeholder="Nombre" name="nameVet"/>
                <input id="load-button"  type="button"  class="btn btn-outline-success" value="Cargar tabla"/>
                <br/>
                <label  class="mb-2 mr-sm-2"> Nombre de la mascota:</label>
                <input id="namepet-input" type="text" class="form-control mb-2 mr-sm-2" placeholder="Nombre" disabled="disabled" name="namepet"/>
                <input id="load-name"  type="button"  class="btn btn-outline-success" disabled="disabled" value="Cargar tabla"/>
                <div class="table-responsive ">
                    <table id="table" class="table table-hover">
                        <thead class="thead-dark">
                        <tr>
                            <th class="column-header"># Visita</th>
                            <th class="column-header">Fecha de la visita</th>
                            <th class="column-header">Tipo</th>
                            <th class="column-header">Descripcion</th>
                            <th class="column-header">Id de la mascota</th>
                        </tr>
                        </thead>
                        <tbody id="body-table">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="imagenes col-sm-4" >
                <img id="dogimage" src="./Img/golden.jpg" class="rounded" alt="Cinque Terre" width="304" height="236">
                <br/><br/>
                <img id="catimage" src="./Img/gato.jpg" class="rounded" alt="Cinque Terre" width="304" height="236">
            </div>
        </div>
        <div class="card-footer  bg-dark text-white" style="margin-top: 175px;">
            <br/><br/>
            <img src="./Img/logo-ub.png"  width="229" height="67">
            <p>David Real, Felipe Segura</p>
            <br/><br/>
        </div>
        <button class="open-button" onclick="openChat();">Chat</button>
        <div class="chat-popup" id="myChat">
            <table class="table-container">
                <tr>
                    <td>
                        <h1>Chat</h1>
                        <textarea readonly="true" rows="5" cols="10" id="log"></textarea>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label><b>Message</b></label>
                        <input placeholder="Type message.." id="msg" required></input>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button type="button" onclick="send();" class="btn">Send</button>
                        <button type="button" class="btn cancel" onclick="closeChat();">Close</button>
                    </td>
                </tr>
            </table>
        </div>
    <script>
        //Checks if the login is done
        if(document.cookie.length===0){
            window.location.href = location.href.replace("vet.html","");
        }

        //Logout button to erase cookies
        document.getElementById("logout-button").onclick = function (){
            document.cookie = "Rol = ; expires = "+Date();
            document.cookie = "usename = ; expires = "+Date();
            window.location.href = location.href.replace("vet.html","");
        };
        document.getElementById("type-input").onclick = function() {
            let tipo = document.getElementById("type-input").value;
            if (tipo == "Implantacion_de_Microchip") {
                console.log("micro")
                document.getElementById("microchip-input").removeAttribute("disabled")
            } else {
                document.getElementById("microchip-input").setAttribute("disabled", "disabled")
            }
        }
        document.getElementById("load-button").onclick = function ()  {
           document.getElementById("body-table").remove();
            let tbody= document.createElement("tbody");
            tbody.setAttribute("id","body-table");
            document.getElementById("table").appendChild(tbody);
            document.getElementById("namepet-input").removeAttribute("disabled");
            document.getElementById("load-name").removeAttribute("disabled");
            let name = document.getElementById("namevet2-input").value;
            document.cookie="name="+name;
            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/visits/')
            .then(response => response.json())
            .then(data =>{
                console.log(data)
                data.forEach((visit)=>{
                    if(visit.vet_id==name){
                        let tr = document.createElement("tr")
                        let visita = {
                            numero : visit.visit_id,
                            fecha : visit.created_at,
                            tipo: visit.type,
                            ds : visit.description,
                            pet: visit.pet_id
                        }
                        Object.keys(visita).forEach((key) => {
                            let td = document.createElement("td");
                            td.innerHTML = visita[key];
                            tr.appendChild(td);
                        });
                        document.getElementById("body-table").appendChild(tr);
                    }
                })
            })
        }

        document.getElementById("load-name").onclick = function () {
            document.getElementById("body-table").remove();
            let tbody= document.createElement("tbody");
            tbody.setAttribute("id","body-table");
            document.getElementById("table").appendChild(tbody);
            let petname = document.getElementById("namepet-input").value;
            let name;
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                if (cookies[i].includes("name")) {
                    name = cookies[i].split("=")[1];
                }
            }

            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/pets')
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    data.forEach((pet) => {
                        if (pet.name == petname) {
                            document.cookie="pet_id="+pet.pet_id;
                        }
                    })
                })
            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/visits/')
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    let id;
                    const cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        if (cookies[i].includes("pet_id")) {
                            id = cookies[i].split("=")[1];
                        }
                    }
                    data.forEach((visit) => {
                        console.log(id+" / "+visit.pet_id)
                        console.log(name+" / "+visit.vet_id)
                        if (visit.vet_id == name && visit.pet_id==id) {
                            let tr = document.createElement("tr")
                            let visita = {
                                numero : visit.visit_id,
                                fecha : visit.created_at,
                                tipo: visit.type,
                                ds : visit.description,
                                pet: visit.pet_id
                            }
                            Object.keys(visita).forEach((key) => {
                                let td = document.createElement("td");
                                td.innerHTML = visita[key];
                                tr.appendChild(td);
                            });
                            document.getElementById("body-table").appendChild(tr);

                        }
                    })
                })

        }

        const form = document.querySelector('form');
        form.addEventListener('submit',handleSubmit)
        function handleSubmit(event) {
            event.preventDefault();
            const data = new FormData(event.target);
            const value = Object.fromEntries(data.entries());
            console.log({value});
            let vet_name = document.getElementById("namevet-input").value;
            let id = document.getElementById("petId-input").value;
            let type = document.getElementById("type-input").value;
            let date = Date();
            let description = document.getElementById("description-input").value;
            let mirch = document.getElementById("microchip-input").value;

            let visit;
            if(type=="Implantacion_de_Microchip"){
                fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/pets')
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    data.forEach((pet) => {
                        if(id==pet.pet_id){
                            if(pet.microchip!=null){
                                window.alert("La mascota ya tiene microchip")
                                event.stopPropagation();
                            }
                        }
                    })
                })
                 visit ={
                    create_at : date,
                    type : type,
                    description :description,
                     pet : {
                         microchip : mirch
                     }
                }
            }else{
                 visit ={
                    create_at : date,
                    type : type,
                    description :description,

                }
            }

            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/users/'+vet_name+'/pets/'+id+'/visit', {
                method: 'POST',
                body: JSON.stringify(visit),
                headers: {
                    'Content-type': 'application/json; charset=UTF-8'
                }
            })
        }
        //Chat Management
        var ws;

        //Open Chat
        function openChat() {
            document.getElementById("myChat").style.display = "block";

            var username = getCookie("username");
            var role = getCookie("Rol");

            var host = document.location.host;
            var pathname = document.location.pathname.split("/")[1];

            ws = new WebSocket("ws://" + host +"/"+ pathname + "/chat/"+role+"/"+ username);

            ws.onmessage = function(event) {
                var log = document.getElementById("log");
                console.log(event.data);
                var message = JSON.parse(event.data);
                log.innerHTML += message.from + " : " + message.content + "\n";
            };
        }
        //Send message
        function send() {
            var content = document.getElementById("msg").value;
            document.getElementById("msg").value = ""
            var json = JSON.stringify({
                "content": content
            });

            ws.send(json);
        }
        //Close chat
        function closeChat() {
            document.getElementById("myChat").style.display = "none";
        }
    </script>
    </body>
</html>
<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="UTF-8">
        <title>Ciudadanos de 4 Patas</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
        <link rel="stylesheet" href="style.css" >
    </head>

    <body id="Body">

        <div class="container">
            <div class="text-center jumbotron" style="margin-bottom:0">
             <h1>Ciudadano de 4 Patas</h1>
             <p> Una campaña para identificar a todos
                estos miembros de nuestras familias como “Ciudadanos de 4 Patas”. Mediante un
                microchip que emite una radiofrecuencia, es posible identificar, registrar y realizar
                seguimiento a todas nuestras mascotas</p>
            </div>
        </div>

        <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
            <img src="./Img/pata.png" style="margin-left:20px" width="75" height="75">
            <a class="navbar-brand" style="margin-left:20px">Bienvenid@</a>
            <b class="text-secondary">   Este es el formulario que debe diligenciar para registrar una nueva mascota</b>

            <button class="btn btn-secondary" id="logout-button">Logout</button>
        </nav>
        <div class="container" style="margin-left: 10px">
            <div class="row">
                <div class="container-sm col-sm-6" style="margin-top:30px"> 
                    <form class="needs-validation"   novalidate>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2"> Nombre de la mascota:</label>
                            <input id="petname-input" type="text" class="form-control mb-2 mr-sm-2" placeholder="Nombre de la mascota" name="petname"required/>
                            <div class="valid-feedback">Validado.</div>
                            <div class="invalid-feedback">Por favor llene este campo.</div>
                        </div>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2"> Numero de Microchip de la mascota:</label>
                            <input id="petmicrochip-input" type="number" min="0" max="10000000000000" class="form-control mb-2 mr-sm-2" placeholder="Microchip" name="petname"/>
                        </div>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Especie:</label>
                            <select id="petspecies-input"required>
                                <option></option>
                                <option>Perro</option>
                                <option>Gato</option>
                            </select>
                            <div class="valid-feedback">Validado.</div>
                            <div class="invalid-feedback">Por favor llene este campo.</div>
                        </div>
                        <label  class="mb-2 mr-sm-2">Raza:</label>
                        <select id="dograza-input" disabled="disabled"required>
                            <option></option>
                        </select>
                        <select id="catraza-input" disabled="disabled"required>
                            <option></option>
                        </select>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Sexo:</label>
                            <select id="petsex-input"required>
                                <option></option>
                                <option>Macho</option>
                                <option>Hembra</option>
                            </select>
                            <div class="valid-feedback">Validado.</div>
                            <div class="invalid-feedback">Por favor llene este campo.</div>
                        </div>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Tamaño:</label>
                            <select id="petsize-input"required>
                                <option></option>
                                <option>Miniatura</option>
                                <option>Pequeño</option>
                                <option>Mediano</option>
                                <option>Grande</option>
                            </select>
                            <div class="valid-feedback">Validado.</div>
                            <div class="invalid-feedback">Por favor llene este campo.</div>
                        </div>
                        <form enctype="multipart/form-data" action="multiPartServlet" method="post">
                            <div>
                                <br/>
                                <input type="file" id="imagen" name="imagensubida" accept="image/png, .jpeg, .jpg, image/gif">
                            </div>
                            <br/><br/>
                            <input id="petsave-button"  type="submit"  class="btn btn-outline-success" value="Guardar"/>
                            <input id="petclean-button" type="reset" class="btn btn-outline-danger"value="Limpiar" />
                        </form>
                    </form>
                </div>
                <div class="container col-sm-4" style="margin-top:30px">
                    <img id="dogimage" src="./Img/golden.jpg" class="rounded" alt="Cinque Terre" width="304" height="236">
                    <br/><br/>
                    <img id="catimage" src="./Img/gato.jpg" class="rounded" alt="Cinque Terre" width="304" height="236">
                </div>
            </div>            
            <br/><br/>
            <div class="container" style="margin-left:20px">
                <br/><br/>
                <div class="table-responsive col-sm-9 container">
                    <table class="table table-hover">
                        <thead class="thead-dark">
                        <tr>
                            <th class="column-header">Foto</th>
                            <th class="column-header">Nombre de la mascota</th>
                            <th class="column-header">Numero de Microchip de la mascota</th>
                            <th class="column-header">Especie</th>
                            <th class="column-header">Sexo</th>
                            <th class="column-header">Tamaño</th>
                            <th class="column-header">Localidad</th>
                            <th class="column-header">Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="body-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card-footer  bg-dark text-white" style="margin-top: 175px;">
            <br/><br/>
            <img src="./Img/logo-ub.png"  width="229" height="67">
            <p>David Real, Felipe Segura</p>
            <br/><br/>
        </div>
        <div class="modal" id="case1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2  class="modal-title">Este Formulario permite editar su mascota</h2>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Localidad:</label>
                            <select id="neightbor-edit">
                                <option></option>
                                <option>A. NARINO</option>
                                <option>B. UNIDOS</option>
                                <option>BOSA</option>
                                <option>C. BOLIVAR</option>
                                <option>CHAPINERO</option>
                                <option>ENGATIVA</option>
                                <option>FONTIBON</option>
                                <option>KENNEDY</option>
                                <option>LA CANDELARIA</option>
                                <option>LOS MARTIRES</option>
                                <option>P. ARANDA</option>
                                <option>R. URIBE</option>
                                <option>SAN CRISTOBAL</option>
                                <option>SANTA FE</option>
                                <option>SUBA</option>
                                <option>SUMAPAZ</option>
                                <option>TEUSAQUILLO</option>
                                <option>TUNJUELITO</option>
                                <option>USAQUEN</option>
                                <option>USME</option>
                            </select>

                        </div>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Direccion:</label>
                            <input id="address-edit" type="text" class="form-control mb-2 mr-sm-2" placeholder="Direccion"/>
                        </div>
                        <div class="form-group">
                            <label id="lable-m" > Numero de Microchip de la mascota:</label>
                            <input id="microchip-edit" type="number" min="0" max="10000000000000" class="form-control mb-2 mr-sm-2" placeholder="Microchip" name="petname"/>
                        </div>
                        <div class="modal-footer">
                            <button id="save-edit1" type="button" class="btn btn-success" data-dismiss="modal">Guardar</button>
                            <button id="close-edit1" type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal " id="case2">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2  class="modal-title">Este Formulario permite editar su mascota</h2>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Localidad:</label>
                            <select id="neightbor-edit2">
                                <option></option>
                                <option>A. NARINO</option>
                                <option>B. UNIDOS</option>
                                <option>BOSA</option>
                                <option>C. BOLIVAR</option>
                                <option>CHAPINERO</option>
                                <option>ENGATIVA</option>
                                <option>FONTIBON</option>
                                <option>KENNEDY</option>
                                <option>LA CANDELARIA</option>
                                <option>LOS MARTIRES</option>
                                <option>P. ARANDA</option>
                                <option>R. URIBE</option>
                                <option>SAN CRISTOBAL</option>
                                <option>SANTA FE</option>
                                <option>SUBA</option>
                                <option>SUMAPAZ</option>
                                <option>TEUSAQUILLO</option>
                                <option>TUNJUELITO</option>
                                <option>USAQUEN</option>
                                <option>USME</option>
                            </select>

                        </div>
                        <div class="form-group">
                            <label  class="mb-2 mr-sm-2">Direccion:</label>
                            <input id="address2-edit" type="text" class="form-control mb-2 mr-sm-2" placeholder="Direccion"/>
                        </div>
                        <div class="modal-footer">
                            <button id="save-edit2" type="button" class="btn btn-success" data-dismiss="modal">Guardar</button>
                            <button id="close-edit2" type="button" class="btn btn-danger" data-dismiss="modal">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
        let catBreeds = [];
        var rowId = 0;

        //Checks if the login is done
        if(document.cookie.length===0){
            window.location.href = location.href.replace("propietario.html","");
        }
        document.getElementById("logout-button").onclick = function (){
            document.cookie = "Rol = ; expires = "+Date();
            document.cookie = "username = ; expires = "+Date();
            window.location.href = location.href.replace("propietario.html","");
        }
        fetch('https://dog.ceo/api/breeds/list/all')
            .then(response => response.json())
            .then(data => {
                let petBreed = document.getElementById("dograza-input");
                Object.keys(data.message).map((breed) => {
                    let option = document.createElement("option");
                    option.innerHTML = breed;
                    petBreed.appendChild(option);
                });
            });

        fetch('https://api.thecatapi.com/v1/breeds')
            .then(response => response.json())
            .then(data => {
                catBreeds = data;
                let catBreed = document.getElementById("catraza-input");
                data.forEach((breed) => {
                    let option = document.createElement("option");
                    option.innerHTML = breed.name;
                    catBreed.appendChild(option);
                });
            });

        const case1 = document.getElementById("case1");
        const case2 = document.getElementById("case2");

        function uploaddata(){
            let user;
            const cookies = document.cookie.split(";");
            for(let i =0; i<cookies.length; i++) {
                if (cookies[i].includes("username")) {
                    user= cookies[i].split("=")[1];
                }
            }
            let owner;
            let neighbor;
            var contador=0;
            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/users')
                .then(response => response.json())
                .then(data =>{
                    console.log(data)
                    data.forEach((id)=>{
                        if("owner"===id.role){
                            contador++;
                        }
                    });

                });
            for (var i=0;i<contador;i++){
                fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/users/owners/'+(i+1))
                .then(response=>response.json())
                .then(data=>{
                    console.log(data);
                    data.forEach((usuario)=>{
                        if (usuario===user){
                            owner=i;
                            neighbor=usuario.neighborhood;
                            i=contador;
                        }
                    })
                })
            }
            fetch('http://localhost:8080/Proyecto-Final-1.0-SNAPSHOT/api/pets')
                .then(response => response.json())
                .then(data =>{
                    console.log(data)
                    data.forEach((pet)=>{
                        if(owner===pet.owner_id){
                            let tr = document.createElement("tr")
                            tr.setAttribute("id", "row-" + (rowId+1));
                            let tdimg = document.createElement("td");
                            let img = document.createElement("img");
                            img.setAttribute("class","rounded")
                            img.setAttribute("id","img-"+(i+1))
                            img.setAttribute("alt","Cinque Terre")
                            img.setAttribute("width","200" )
                            img.setAttribute("height","156")
                            img.setAttribute("src","./uploads/"+pet.picture)
                            tdimg.appendChild(img);
                            tr.appendChild(tdimg);
                            let pets= {

                                petname: pet.name,
                                microchipnum: pet.microchip,
                                petspecie: pet.species,
                                petsex: pet.sex,
                                petsize: pet.size,
                                neightborinput: neighbor

                            }
                            Object.keys(pets).forEach((key) => {
                                let td = document.createElement("td");
                                td.innerHTML= pets[key];
                                tr.appendChild(td);
                            });
                            let tdActions = document.createElement("td");

                            //tr.appendChild(tdActions);
                            let inputeditar = document.createElement("input");
                            inputeditar.setAttribute("id", "editar-" + (i+1));
                            inputeditar.setAttribute("type", "button");
                            inputeditar.setAttribute("data-toggle","modal" )
                            inputeditar.value = "Editar";

                            inputeditar.onclick = function() {
                                console.log("se leyo editar 1")
                                let id = this.getAttribute("id");
                                id = +id.replace("editar-", "");
                                if(pet.microchip==""){
                                    document.getElementById("editar-"+id).setAttribute("data-target","case1")
                                    case1.style.display = "block";
                                    case1.style.paddingRight = "17px";
                                    case1.className="modal fade show";
                                    document.getElementById("lable-m").setAttribute("class",+id+"");
                                }else{
                                    document.getElementById("editar-"+id).setAttribute("data-target","case2")
                                    case2.style.display = "block";
                                    case2.style.paddingRight = "17px";
                                    case2.className="modal fade show";
                                    document.getElementById("lable-m").setAttribute("class",+id+"");
                                }
                            };
                            tdActions.appendChild(inputeditar);
                            tr.appendChild(tdActions);
                            document.getElementById("body-table").appendChild(tr);
                        }
                    })
                })


        };
        uploaddata();


        document.getElementById("save-edit1").onclick= function(){
            let id = document.getElementById("lable-m").getAttribute("class")
            document.getElementById("lable-m").removeAttribute("class")
            case1.style.display = "none";
            case1.className="modal fade";

        };
        document.getElementById("close-edit1").onclick=function() {
            case1.style.display = "none";
            case1.className="modal fade";
        };

        document.getElementById("save-edit2").onclick= function(){
            let id = document.getElementById("lable-m").getAttribute("class")
            document.getElementById("lable-m").removeAttribute("class")
            case2.style.display = "none";
            case2.className="modal fade";

        };
        document.getElementById("close-edit2").onclick=function() {
            case2.style.display = "none";
            case2.className="modal fade";
        };



        document.getElementById("petspecies-input").onclick = function(){
            let raza =document.getElementById("petspecies-input").value;
            if(raza=="Perro"){
                console.log("Perro")
                document.getElementById("dograza-input").removeAttribute("disabled")
                document.getElementById("catraza-input").setAttribute("disabled",true)
            }else if(raza=="Gato"){
                console.log("gato")
                document.getElementById("catraza-input").removeAttribute("disabled")
                document.getElementById("dograza-input").setAttribute("disabled",true)
            }
        };

        (function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        console.log(form.checkValidity())
                        event.preventDefault();
                        event.stopPropagation();
                    }else if(form.checkValidity()===true){
                        rowId += 1;
                        event.preventDefault();
                        event.stopPropagation();
                        alert("Registro creado");
                        window.location.reload()
                        console.log(document.getElementById("row-"+rowId))
                    };
                    form.classList.add('was-validated');
                }, false);
            });
            ;
        })();

    </script>
    </body>
</html>